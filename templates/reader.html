<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Reader</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>  

              :root {
    --main-bg: #ededed;
    --page-bg: #fff;
    --text-color: #1c1c1c;
}

body {
    background: var(--main-bg);
    color: var(--text-color);
    margin: 0;
    font-family: 'Segoe UI', 'Inter', 'Arial', sans-serif;
}

/* RENK BARINI √úSTE SABƒ∞TLE */
#themebar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    z-index: 10001;
    background: #fff;
    border-radius: 0 0 18px 18px;
    box-shadow: 0 2px 10px #0001;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 8px 20px;
}

/* Font bar √ºstte (renk barƒ± ile aynƒ± hizadan ba≈ülatƒ±yoruz) */
#fontbar {
    position: fixed;
    top: 54px; /* themebar'ƒ±n altƒ±nda g√∂z√ºks√ºn */
    left: 18px;
    z-index: 1001;
    background: #fff;
    border-radius: 13px;
    box-shadow: 0 2px 8px #b2b8c766;
    display: flex;
    align-items: center;
    gap: 7px;
    padding: 4px 10px 4px 7px;
    opacity: .97;
}

#themebar button, #fontbar button {
    padding: 4px 10px;
    border: none;
    border-radius: 7px;
    cursor: pointer;
    font-weight: 600;
    font-size: 1em;
}
#themebar .active, #fontbar .active {
    background: #2e6be6;
    color: #fff;
}

/* Saƒü alta utility bar */
#utility-bar {
    position: fixed;
    right: 24px;
    bottom: 28px;
    z-index: 1200;
    background: #fff;
    border-radius: 14px;
    box-shadow: 0 2px 8px #b2b8c766;
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding: 10px 8px;
    opacity: 0.97;
}

/* Okuma alanƒ±nƒ±n √ºst√ºnde bo≈üluk bƒ±rak */
#text-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 34px;
    padding: 38px 0 60px 0;
    min-height: 100vh;
    margin-top: 65px; /* themebar y√ºksekliƒüi kadar */
}

/* Sayfa kutusu */
.page {
    background: var(--page-bg);
    border-radius: 7px;
    box-shadow: 0 0 20px 1.5px #d0d4db;
    padding: 50px 44px 38px 44px;
    font-size: 1.15em;
    line-height: 1.65;
    min-height: 430px;
    max-width: 800px;
    margin: 0 auto;
    width: 100%;
    box-sizing: border-box;
    position: relative;
}
.page-num {
    position: absolute;
    left: 24px;
    top: 17px;
    color: #9ea6bd;
    font-size: .97em;
    opacity: .8;
    letter-spacing: .5px;
    font-weight: 600;
}
.page-speaker,
.page-stop {
    position: absolute;
    right: 54px;
    top: 13px;
    cursor: pointer;
    font-size: 1.22em;
    color: #366be6;
}
.page-stop {
    right: 20px;
    color: #de3a3a;
    font-size: 1.15em;
}

/* Alƒ±ntƒ± barƒ± (se√ßili metin) */
#quote-bar {
    display: none;
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1201;
    background: #f5e7fd;
    padding: 9px 20px;
    border-radius: 12px;
    box-shadow: 0 1px 8px #b2b8c790;
}

/* Sayfa atlama kutusu */
#jumper {
    position: fixed;
    top: 80px;
    right: 20px;
    z-index: 1002;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 1px 8px #b2b8c74a;
    padding: 7px 15px 7px 13px;
    display: flex;
    align-items: center;
    gap: 8px;
}
#jumper input {
    width: 55px;
    border: 1px solid #bbb;
    border-radius: 6px;
    font-size: 1.1em;
    padding: 3px 6px;
}
#jumper button {
    background: #2e6be6;
    color: #fff;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    padding: 3px 15px;
    font-size: 1em;
    cursor: pointer;
}
#current-page-label {
    position: fixed;
    right: 24px;
    bottom: 22px;
    z-index: 1002;
    background: #24292f;
    color: #fff;
    padding: 9px 16px 9px 14px;
    border-radius: 16px;
    box-shadow: 0 1px 10px #b2b8c790;
    font-size: 1.07em;
    font-weight: 600;
    opacity: .93;
    pointer-events: none;
    transition: opacity .15s;
}

/* Responsive (mobil ve tablet) */
@media (max-width:900px) {
    #themebar { position: static; width: auto; border-radius: 0; box-shadow: none; justify-content: flex-start; padding: 7px 7vw 8px 7vw; }
    #fontbar { position: static; margin-bottom: 8px; }
    #jumper { position: static; margin-bottom: 8px; }
    #utility-bar { right: 12px; bottom: 12px; }
    #text-content { padding: 15px 0 32px 0; margin-top: 10px; }
    .page { padding: 18px 2vw 22px 2vw; max-width: 99vw; min-height: 180px; }
    #current-page-label { left: 50%; right: auto; bottom: 10px; transform: translateX(-50%);}
    .page-speaker, .page-stop { right: 48px; top: 12px;}
}

/* Word Popup */
#word-popup {
    display: none;
    position: absolute;
    background: #24292f;
    color: #fff;
    padding: 8px 14px;
    border-radius: 12px;
    box-shadow: 0 4px 24px rgba(20,20,20,0.18);
    z-index: 9999;
    min-width: 100px;
    max-width: 350px;
    word-break: break-word;
    font-size: 1.03em;
    transition: opacity 0.1s;
}
#word-popup .close-btn { float: right; cursor: pointer; margin-left: 10px; font-weight: bold;}
#word-popup .popup-speaker { cursor:pointer;font-size:1.12em;margin-right:7px;color:#36c;vertical-align:middle;}
#word-popup .star-fav { cursor:pointer;font-size:1.1em;color:#ffc500;margin-right:7px;vertical-align:middle; }
#word-popup .edit-note { cursor:pointer;font-size:1.1em;color:#28a745;margin-left:8px;vertical-align:middle;}

/* Modal stilleri */
#favorites-modal, #sources-modal, #stats-modal, #note-modal, #translate-modal, #quotes-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: #1118;
    z-index: 10001;
    align-items: center;
    justify-content: center;
}
.modal-content {
    background: #fff;
    border-radius: 17px;
    box-shadow: 0 6px 32px #2228;
    min-width: 280px;
    max-width: 355px;
    width: 92vw;
    max-height: 420px;
    overflow-y: auto;
    position: relative;
    padding: 23px 17px 17px 17px;
}
.modal-content h3 { margin: 0 0 12px 0; font-weight: 600; color: #234; font-size: 1.15em;}
.close-modal { position: absolute; top: 7px; right: 13px; cursor: pointer; font-size: 1.35em; color: #666; }
.fav-list-item { margin-bottom: 13px; border-bottom: 1px solid #e3e6eb; padding-bottom: 7px;}
.fav-note { display: block; font-size: .98em; color: #18b; margin: 5px 0 0 0;}
.fav-tag { font-size: .96em; color: #aaa; margin-left: 6px; }
.tag-select { border-radius: 7px; padding: 3px 8px; font-size: 1em;}
#stats-content { font-size: 1.04em; line-height: 1.55; }
.btn { background: #e2ecfa; color: #225; padding: 5px 14px; border: none; border-radius: 6px; font-size: 1em; cursor: pointer;}
.btn-red { background: #fadede; color: #d44; }

        




    </style>
</head>
<body>

    <!-- Tema se√ßici -->
    <div id="themebar">
        <span style="color:#888; font-weight:500;">Renk:</span>
        <button id="lightBtn" onclick="setTheme('light')">A√ßƒ±k</button>
        <button id="greyBtn" onclick="setTheme('grey')">Gri</button>
        <button id="darkBtn" onclick="setTheme('dark')">Koyu</button>
        <button onclick="showStatsModal()" style="margin-left:12px;padding:5px 10px 5px 9px;background:#e8ebfd;">üìà ƒ∞statistik</button>
        <button onclick="showFavoritesModal()" style="margin-left:4px;padding:5px 10px;background:#fff5e3;">‚òÖ Favorilerim</button>
    </div>

<!-- Quote Bar (Se√ßili Metin i√ßin Alƒ±ntƒ±) -->
<div id="quote-bar" style="display:none; position:fixed; bottom:20px; left:50%; transform:translateX(-50%); z-index:1201; background:#f5e7fd; padding:9px 20px; border-radius:12px; box-shadow:0 1px 8px #b2b8c790;">
    <span id="selected-quote-text"></span>
    <button id="add-quote-btn" style="margin-left:20px;">‚ûï Alƒ±ntƒ± Ekle</button>
</div>





    <!-- Font b√ºy√ºt/k√º√ß√ºlt -->
    <div id="fontbar">
        <button id="decfont" onclick="setFont('decrease')">A-</button>
        <button id="incfont" onclick="setFont('increase')">A+</button>
        <button onclick="showTranslateModal()" style="margin-left:12px;padding:5px 10px 5px 9px;background:#e7f3e3;">üåê Se√ßili Metni √áevir</button>
    </div>

     <!--
== EKLEME 1 ==




A≈üaƒüƒ±daki kodu <body> a√ßƒ±ldƒ±ktan ve <div id="themebar"> ile <div id="fontbar"> bittikten hemen SONRA ekle.
-->

<!-- Saƒü altta utility bar -->
<div id="utility-bar">
<div id="utility-bar" style="position:fixed; right:24px; bottom:60px; z-index:1200; background:#fff; border-radius:14px; box-shadow:0 2px 8px #b2b8c766; display:flex; flex-direction:column; gap:10px; padding:10px 8px; opacity:0.97;">
    <button id="bookshelf-btn" title="Kitaplƒ±k" onclick="window.location.href='/'" style="font-size:1.08em; padding:7px 12px; border-radius:9px; border:none; background:#ecf4ff; cursor:pointer;">üìö</button>
    <button id="fav-btn" title="Favorilerim" style="font-size:1.08em; padding:7px 12px; border-radius:9px; border:none; background:#fffbe3; cursor:pointer;">‚≠ê</button>
    <button id="quotes-btn" title="Alƒ±ntƒ±larƒ±m" style="font-size:1.08em; padding:7px 12px; border-radius:9px; border:none; background:#f5e7fd; cursor:pointer;">üìñ</button>
</div>


<script>
  document.getElementById("bookshelf-btn").addEventListener("click", function() {
    window.location.href = "{{ url_for('index', _external=True) }}";
  });
</script>

    

</div>


    <!-- Sayfa atlama -->
    <div id="jumper">
        <span style="color:#2e6be6;font-weight:600;">Sayfaya Git:</span>
        <input type="number" id="jumptopage" min="1" max="{{ page_count }}" placeholder="1-{{ page_count }}">
        <button onclick="jumpToPage()">Git</button>
    </div>
    <!-- Hangi sayfadasƒ±n etiketi -->
    <div id="current-page-label" style="display:none;"></div>
    <!-- Metin -->
    
    <div id="text-content" style="padding-top: 52px; position: relative;">

  <!-- Sabit √úst √áubuk -->
  <div style="
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: #fdfdfd;
      z-index: 1000;
      padding: 8px 16px;
      display: flex;
      align-items: center;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
  ">
    <span class="page-speaker" title="Sayfayƒ± oku" onclick="speakPage(currentPageIndex)"
          style="font-size: 20px; margin-right: 16px; cursor: pointer;">üîä</span>

    <span class="page-stop" title="Okumayƒ± Durdur" onclick="stopSpeak()"
          style="font-size: 20px; margin-right: 16px; cursor: pointer;">‚èπÔ∏è</span>

    <span id="page-number-display" style="font-size: 16px; color: #333;">Sayfa 1</span>
  </div>

  {% for page in pages %}
    <div class="page" id="page-{{ loop.index0 }}">
        {{ page|safe }}
    </div>
  {% endfor %}
</div>
    

    <!-- Kelime Pop-up -->
    <div id="word-popup"><span class="close-btn" onclick="hidePopup()">√ó</span><span id="popup-content"></span></div>

    <!-- MODALS -->
    <!-- Dƒ±≈ü Kaynaklar Modalƒ± -->
    <div id="sources-modal">
      <div class="modal-content">
        <span class="close-modal" onclick="closeSourcesModal()">√ó</span>
        <h3>Dƒ±≈ü Kaynaklarda Ara</h3>
        <div id="sources-links"></div>
      </div>
    </div>
    <!-- Favoriler Modalƒ± -->
    <div id="favorites-modal">
      <div class="modal-content">
        <span class="close-modal" onclick="closeFavoritesModal()">√ó</span>
        <h3>‚òÖ Favori Kelimeler</h3>
        <div id="favorites-list"></div>
        <button class="btn btn-red" onclick="clearFavorites()">T√ºm Favorileri Sil</button>
      </div>
    </div>
    <!-- ƒ∞statistik Modalƒ± -->
    <div id="stats-modal">
      <div class="modal-content">
        <span class="close-modal" onclick="closeStatsModal()">√ó</span>
        <h3>üìà Okuma ƒ∞statistikleri</h3>
        <div id="stats-content"></div>
      </div>
    </div>
    <!-- Not Ekle Modalƒ± -->
    <div id="note-modal">
      <div class="modal-content">
        <span class="close-modal" onclick="closeNoteModal()">√ó</span>
        <h3>üìù Notunu Ekle</h3>
        <div id="note-form"></div>
      </div>
    </div>
    <!-- Se√ßili Metni √áevir Modalƒ± -->
    <div id="translate-modal">
      <div class="modal-content">
        <span class="close-modal" onclick="closeTranslateModal()">√ó</span>
        <h3>üåê Se√ßili Metni √áevir</h3>
        <div id="translate-area"></div>
      </div>
    </div>

     <!-- Alƒ±ntƒ±larƒ±m Modalƒ± -->
<div id="quotes-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:#1118; z-index:10001; align-items:center; justify-content:center;">
  <div class="modal-content">
    <span class="close-modal" onclick="closeQuotesModal()">√ó</span>
    <h3>üìñ Alƒ±ntƒ±larƒ±m</h3>
    <div id="quotes-list"></div>
  </div>
</div>


    <!-- SCRIPTLER -->
    <script src="{{ url_for('static', filename='app.js') }}"></script>
    <script>
        // ========== Tema, Font, Sayfa Atlama, Scroll Sayfa, Sesli Okuma, Modal A√ßma-Kapama Fonksiyonlarƒ± ==========
        // ... (BURAYA √ñNCEKƒ∞ reader.html'de kullandƒ±ƒüƒ±n ana JS fonksiyonlarƒ±nƒ± ekle! Kendi scroll, tema ve sayfa i≈ülevlerini aynen kullanabilirsin.)
    </script>
    <script>
    // ========== KELƒ∞ME POPUP ƒ∞≈ûLEVLERƒ∞ ==========
    // Pop-up'ta favori, not ekleme, geli≈ümi≈ü ses, kaynak modalƒ±, istatistik vs. 
    // ... (BU KISMI EN ƒ∞Yƒ∞ ≈ûEKƒ∞LDE ENTEGRE ETMEK ƒ∞√áƒ∞N, √ñNCE reader.html JS KISMINI VE app.js'yi G√úNCELLEMEK GEREKƒ∞R.)

    // *** Buraya, her kelimeye tƒ±klandƒ±ƒüƒ±nda kelime popup'ƒ±, favori ekleme, not ekleme, anlam yoksa dƒ±≈ü kaynaklar vs. i√ßin gerekli kodlarƒ± ekleyeceƒüiz. ***
    // *** Kodlar uzun olduƒüu i√ßin buraya sƒ±ƒümadƒ±, dilersen hemen "tamamƒ±nƒ± devam ettir" de, JS kodlarƒ±nƒ±n tamamƒ±nƒ± payla≈üayƒ±m. ***

    // Not: T√ºm favoriler, notlar, istatistikler localStorage'da tutulacak.
    </script>

<script>
document.addEventListener("mouseup", function() {
    let txt = window.getSelection().toString().trim();
    let bar = document.getElementById("quote-bar");
    if (txt.length > 2) {
        document.getElementById("selected-quote-text").textContent = txt.length > 100 ? txt.substr(0,100)+"..." : txt;
        bar.style.display = "block";
    } else {
        bar.style.display = "none";
    }
});
document.getElementById("add-quote-btn").onclick = function() {
    let txt = window.getSelection().toString().trim();
    if (!txt) return;
    let arr = JSON.parse(localStorage.getItem("alinanAlintilar") || "[]");
    let note = prompt("Bu alƒ±ntƒ± i√ßin not eklemek ister misin? (ƒ∞steƒüe baƒülƒ±)", "");
    arr.unshift({text: txt, note: note||"", date: new Date().toLocaleString()});
    localStorage.setItem("alinanAlintilar", JSON.stringify(arr));
    document.getElementById("quote-bar").style.display = "none";
    alert("Alƒ±ntƒ± eklendi!");
};
</script>





    <!--
== EKLEME 4 ==
A≈üaƒüƒ±daki script bloƒüunu, t√ºm <script> taglerinin en sonuna veya ayrƒ± app.js dosyanƒ±n en sonuna ekle.
-->

<script>
// === ALINTILAR === //
function getQuotes() { return JSON.parse(localStorage.getItem("alinanAlintilar") || "[]"); }
function saveQuotes(arr) { localStorage.setItem("alinanAlintilar", JSON.stringify(arr)); }

document.addEventListener("mouseup", function() {
    let txt = window.getSelection().toString().trim();
    let bar = document.getElementById("quote-bar");
    if (txt.length > 2) {
        document.getElementById("selected-quote-text").textContent = txt.length > 100 ? txt.substr(0,100)+"..." : txt;
        bar.style.display = "block";
    } else {
        bar.style.display = "none";
    }
});

document.getElementById("add-quote-btn").onclick = function() {
    let txt = window.getSelection().toString().trim();
    if (!txt) return;
    let arr = getQuotes();
    let note = prompt("Bu alƒ±ntƒ± i√ßin not eklemek ister misin? (ƒ∞steƒüe baƒülƒ±)", "");
    arr.unshift({text: txt, note: note||"", date: new Date().toLocaleString()});
    saveQuotes(arr);
    document.getElementById("quote-bar").style.display = "none";
    alert("Alƒ±ntƒ± eklendi!");
};

document.getElementById("quotes-btn").onclick = function() {
    let arr = getQuotes();
    let html = arr.length==0 ? "<div>Hen√ºz alƒ±ntƒ± eklemedin.</div>" :
      arr.map(q=>`
        <div style="border-bottom:1px solid #eee;padding:7px 0 8px 0;">
            <div style="font-size:1.07em;margin-bottom:7px;">"${q.text}"</div>
            <div style="font-size:.97em;color:#555;">${q.note?'<b>Not:</b> '+q.note+'<br>':''}<span style="color:#888;font-size:.96em;">${q.date}</span></div>
        </div>
      `).join("");
    html += arr.length? `<button class="btn btn-red" onclick="clearQuotes()" style="margin-top:9px;">T√ºm√ºn√º Sil</button>` : "";
    document.getElementById("quotes-list").innerHTML = html;
    document.getElementById("quotes-modal").style.display = "flex";
};
function closeQuotesModal() { document.getElementById("quotes-modal").style.display="none"; }
function clearQuotes() {
    if (confirm("T√ºm alƒ±ntƒ±larƒ± silmek istediƒüine emin misin?")) {
        saveQuotes([]);
        document.getElementById("quotes-modal").style.display="none";
    }
}

// Utility Bar Butonlarƒ± (Favori, ƒ∞statistik, Alƒ±ntƒ±)
document.getElementById("fav-btn").onclick = showFavoritesModal;
document.getElementById("stats-btn").onclick = showStatsModal;
</script>


    



  <script>


/* === TEMA, FONT, SAYFA ATLAMA, SAYFA TAKƒ∞P === */
function setTheme(mode) {
    document.getElementById('lightBtn').classList.remove('active');
    document.getElementById('greyBtn').classList.remove('active');
    document.getElementById('darkBtn').classList.remove('active');
    if (mode === 'light') {
        document.body.style.setProperty('--main-bg', '#ededed');
        document.body.style.setProperty('--page-bg', '#fff');
        document.body.style.setProperty('--text-color', '#1c1c1c');
        document.getElementById('lightBtn').classList.add('active');
    }
    if (mode === 'grey') {
        document.body.style.setProperty('--main-bg', '#d2d6db');
        document.body.style.setProperty('--page-bg', '#f7f8fa');
        document.body.style.setProperty('--text-color', '#1c1c1c');
        document.getElementById('greyBtn').classList.add('active');
    }
    if (mode === 'dark') {
        document.body.style.setProperty('--main-bg', '#202329');
        document.body.style.setProperty('--page-bg', '#282c35');
        document.body.style.setProperty('--text-color', '#f1f2f7');
        document.getElementById('darkBtn').classList.add('active');
    }
    localStorage.setItem('theme', mode);
}
setTheme(localStorage.getItem('theme') || 'light');

// Font b√ºy√ºt/k√º√ß√ºltme
let fontSize = parseFloat(localStorage.getItem('fontsize')) || 1.15;
function setFont(action) {
    if (action === 'increase') fontSize += 0.08;
    if (action === 'decrease') fontSize = Math.max(0.8, fontSize - 0.08);
    document.querySelectorAll('.page').forEach(p => p.style.fontSize = fontSize + "em");
    localStorage.setItem('fontsize', fontSize);
}
setFont();

// Sayfaya git
function jumpToPage() {
    let val = parseInt(document.getElementById('jumptopage').value);
    if (!val || val < 1) val = 1;
    if (val > {{ page_count }}) val = {{ page_count }};
    const idx = val - 1;
    const target = document.getElementById('page-' + idx);
    if (target) {
        target.scrollIntoView({behavior: "smooth", block:"start"});
    }
}
document.getElementById('jumptopage').addEventListener('keydown', function(e) {
    if (e.key === "Enter") jumpToPage();
});

// Aktif sayfa scroll ile otomatik g√∂ster
function getCurrentPage() {
    const pages = document.querySelectorAll('.page');
    let current = 1;
    let minDiff = Infinity;
    let winTop = window.scrollY;
    pages.forEach((pg, i) => {
        const rect = pg.getBoundingClientRect();
        const diff = Math.abs(rect.top - 80);
        if (diff < minDiff) {
            minDiff = diff;
            current = i+1;
        }
    });
    return current;
}
let label = document.getElementById('current-page-label');
function showPageLabel() {
    let c = getCurrentPage();
    label.textContent = "Sayfa " + c + " / {{ page_count }}";
    label.style.display = "block";
    clearTimeout(label.timer);
    label.timer = setTimeout(() => label.style.display = "none", 1300);
}
window.addEventListener('scroll', showPageLabel);

/* === GELƒ∞≈ûMƒ∞≈û SESLƒ∞ OKUMA (Sayfa ve Kelime) === */
window.speakPage = function(idx) {
    let page = document.getElementById('page-' + idx);
    if (!page) return;
    let words = Array.from(page.querySelectorAll('.word')).map(e => e.textContent);
    let text = words.join(' ');
    const utter = new window.SpeechSynthesisUtterance(text);
    utter.lang = 'de-DE';
    utter.rate = parseFloat(localStorage.getItem("ttsRate")) || 1.0;
    utter.voice = getVoice();
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(utter);
};
window.stopSpeak = function() { window.speechSynthesis.cancel(); };

// Ses se√ßimi ve hƒ±z kontrol√º
function getVoice(gender="any") {
    let voices = window.speechSynthesis.getVoices().filter(v=>v.lang.startsWith('de'));
    if (gender==="male") return voices.find(v=>v.name.toLowerCase().includes("male")) || voices[0];
    if (gender==="female") return voices.find(v=>v.name.toLowerCase().includes("female")) || voices[0];
    return voices[0];
}
function setTTSRate(rate) { localStorage.setItem("ttsRate", rate); }

/* === FAVORƒ∞, NOT, ƒ∞STATƒ∞STƒ∞K, DI≈û KAYNAK, POPUP, √áEVƒ∞RME, ETƒ∞KET Sƒ∞STEMƒ∞ === */
// Local storage i√ßin yardƒ±mcƒ± fonksiyonlar
function getFavs() { return JSON.parse(localStorage.getItem("favoriKelimeler") || "[]"); }
function saveFavs(favs) { localStorage.setItem("favoriKelimeler", JSON.stringify(favs)); }
function getStats() { return JSON.parse(localStorage.getItem("okumaIstatistik") || "{}"); }
function saveStats(stats) { localStorage.setItem("okumaIstatistik", JSON.stringify(stats)); }

// Pop-up event delegation
document.addEventListener("DOMContentLoaded", function() {
    // Kelimeye tƒ±klama
    document.getElementById('text-content').addEventListener('click', async function(event) {
        let target = event.target;
        if (target.classList.contains('word')) {
            const word = target.textContent.trim();
            let response = await fetch('/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ word: word })
            });
            let data = await response.json();
            showWordPopup(target, data);
            updateStats(word);
        }
    });
});

function showWordPopup(target, data) {
    const popup = document.getElementById('word-popup');
    const popupContent = document.getElementById('popup-content');
    let favs = getFavs();
    let isFav = favs.some(f => f.kelime === data.word);
    let myNote = (favs.find(f=>f.kelime===data.word)||{}).not || "";
    let myTag = (favs.find(f=>f.kelime===data.word)||{}).etiket || "";
    popupContent.innerHTML = `
        <span class="popup-speaker" title="Oku" onclick="playWord('${data.word}')">üîä</span>
        <span class="star-fav" title="Favorilere ekle" onclick="toggleFav('${data.word}','${(data.anlam||"-").replace(/'/g,"")}')">${isFav?"‚òÖ":"‚òÜ"}</span>
        <strong>${data.word}</strong>
        <span style="color:#aaf;">${data.artikel||""}</span>
        <span class="edit-note" onclick="openNoteModal('${data.word}')">üìù</span>
        <span style="float:right;">
          <select class="tag-select" onchange="setFavTag('${data.word}',this.value)">
            <option value="">Etiket se√ß</option>
            <option value="g√ºnl√ºk" ${myTag==="g√ºnl√ºk"?"selected":""}>G√ºnl√ºk</option>
            <option value="bilim" ${myTag==="bilim"?"selected":""}>Bilim</option>
            <option value="fiil" ${myTag==="fiil"?"selected":""}>Fiil</option>
            <option value="edebi" ${myTag==="edebi"?"selected":""}>Edebi</option>
          </select>
        </span>
        <br>
        <em>${data.lemma ? '['+data.lemma+']' : ''}</em><br>
        <span>${data.anlam || 'Anlam bulunamadƒ±.'}</span>
        ${myNote?`<div class="fav-note">Not: ${myNote}</div>`:""}
    `;
    // Eƒüer anlam bulunamadƒ±ysa, dƒ±≈ü kaynaklar butonu
    if (data.anlam === "-" || data.error) {
        popupContent.innerHTML += `<br><button class="btn" onclick="showSourcesModal('${data.word}')">Daha fazla kaynak‚Ä¶</button>`;
    }
    // Konumlandƒ±rma
    popup.style.display = "none"; popup.style.opacity = 0;
    const rect = target.getBoundingClientRect();
    const scrollY = window.scrollY || document.documentElement.scrollTop;
    const scrollX = window.scrollX || document.documentElement.scrollLeft;
    let top = rect.bottom + scrollY + 6;
    let left = rect.left + scrollX;
    if (left + popup.offsetWidth > window.innerWidth) left = window.innerWidth - popup.offsetWidth - 15;
    if (top + popup.offsetHeight > window.innerHeight + scrollY) top = rect.top + scrollY - popup.offsetHeight - 10;
    popup.style.left = `${left}px`; popup.style.top = `${top}px`;
    popup.style.display = "block"; setTimeout(()=>popup.style.opacity=1,10);
}
function hidePopup() { document.getElementById('word-popup').style.display = "none"; }

// Kelime okuma
window.playWord = function(word) {
    function speakNow() {
        const utter = new window.SpeechSynthesisUtterance(word);
        utter.lang = 'de-DE';
        utter.voice = getVoice();
        utter.rate = parseFloat(localStorage.getItem("ttsRate")) || 1.0;
        window.speechSynthesis.cancel(); window.speechSynthesis.speak(utter);
    }
    if (window.speechSynthesis.getVoices().length) speakNow();
    else setTimeout(()=>speakNow(), 400);
};

// Favori ekle/√ßƒ±kar
window.toggleFav = function(word, anlam) {
    let favs = getFavs();
    let ix = favs.findIndex(f=>f.kelime===word);
    if (ix<0) favs.push({kelime:word, anlam:anlam, not:"", etiket:""});
    else favs.splice(ix,1);
    saveFavs(favs);
    hidePopup();
};
// Etiket g√ºncelle
window.setFavTag = function(word, val) {
    let favs = getFavs();
    let ix = favs.findIndex(f=>f.kelime===word);
    if (ix>=0) { favs[ix].etiket = val; saveFavs(favs);}
};
// Not ekle modalƒ± a√ß
window.openNoteModal = function(word) {
    let favs = getFavs(), ix = favs.findIndex(f=>f.kelime===word);
    if (ix<0) {favs.push({kelime:word, anlam:"-", not:"", etiket:""}); ix=favs.length-1;}
    let note = favs[ix].not||"";
    document.getElementById("note-form").innerHTML = `
      <div style="font-weight:600;margin-bottom:8px;">Kelime: <span style="color:#26a">${word}</span></div>
      <textarea id="usernote" style="width:98%;height:50px;font-size:1.07em;border-radius:8px;">${note}</textarea>
      <br>
      <button class="btn" onclick="saveNote('${word}')">Kaydet</button>
    `;
    document.getElementById("note-modal").style.display = "flex";
};
window.saveNote = function(word) {
    let favs = getFavs(), ix = favs.findIndex(f=>f.kelime===word);
    if (ix<0) return;
    favs[ix].not = document.getElementById("usernote").value;
    saveFavs(favs);
    document.getElementById("note-modal").style.display = "none";
};

// Favoriler modalƒ±
window.showFavoritesModal = function() {
    let favs = getFavs();
    let html = favs.length==0 ? "<div>Hi√ß favori kelimen yok.</div>" :
      favs.map(f=>`
        <div class="fav-list-item">
            <b>${f.kelime}</b> <span class="fav-tag">${f.etiket||""}</span>
            <div>${f.anlam||""}</div>
            ${f.not?`<div class="fav-note">Not: ${f.not}</div>`:""}
            <button class="btn btn-red" style="margin-top:4px" onclick="removeFav('${f.kelime}')">Sil</button>
        </div>
      `).join("");
    document.getElementById("favorites-list").innerHTML = html;
    document.getElementById("favorites-modal").style.display = "flex";
};
window.removeFav = function(word) {
    let favs = getFavs();
    favs = favs.filter(f=>f.kelime!==word);
    saveFavs(favs);
    showFavoritesModal();
};
window.clearFavorites = function() {
    if (confirm("T√ºm favorileri silmek istediƒüine emin misin?")) {
        saveFavs([]);
        showFavoritesModal();
    }
};
window.closeFavoritesModal = function() { document.getElementById("favorites-modal").style.display="none"; };

// Dƒ±≈ü kaynak modalƒ±
window.showSourcesModal = function(word) {
    const links = [
        {name:"Google Translate", url:`https://translate.google.com/?sl=de&tl=tr&text=${encodeURIComponent(word)}&op=translate`},
        {name:"PONS", url:`https://de.pons.com/√ºbersetzung/deutsch-tuerkisch/${encodeURIComponent(word)}`},
        {name:"DWDS", url:`https://www.dwds.de/wb/${encodeURIComponent(word)}`},
        {name:"Duden", url:`https://www.duden.de/rechtschreibung/${encodeURIComponent(word)}`},
        {name:"Leo", url:`https://dict.leo.org/german-turkish/${encodeURIComponent(word)}`},
        {name:"Linguee", url:`https://www.linguee.com/german-turkish/search?source=german&query=${encodeURIComponent(word)}`},
        {name:"Tureng", url:`https://tureng.com/tr/turkce-almanca/${encodeURIComponent(word)}`},
        {name:"Wiktionary", url:`https://en.wiktionary.org/wiki/${encodeURIComponent(word)}`},
        {name:"Reverso", url:`https://context.reverso.net/translation/german-turkish/${encodeURIComponent(word)}`},
        {name:"Langenscheidt", url:`https://de.langenscheidt.com/deutsch-tuerkisch/${encodeURIComponent(word)}`}
    ];
    let html = links.map(l=>`<div style="margin-bottom:10px;">
        <a href="${l.url}" target="_blank" style="color:#246be6;font-weight:600;font-size:1.07em;text-decoration:none;">
            <span style="margin-right:7px;">üîó</span>${l.name}
        </a>
    </div>`).join("");
    document.getElementById("sources-links").innerHTML = html;
    document.getElementById("sources-modal").style.display = "flex";
};
window.closeSourcesModal = function() { document.getElementById("sources-modal").style.display="none"; };

// ƒ∞statistik modalƒ± ve g√ºncellemesi
function updateStats(word) {
    let stats = getStats();
    stats.tarihce = stats.tarihce || {};
    stats.tarihce[word] = (stats.tarihce[word]||0)+1;
    stats.toplamKelime = (stats.toplamKelime||0)+1;
    stats.okumaZamani = Date.now();
    saveStats(stats);
}
window.showStatsModal = function() {
    let stats = getStats();
    let kelimeSay = stats.toplamKelime||0;
    let enCok = Object.entries((stats.tarihce||{})).sort((a,b)=>b[1]-a[1]).slice(0,5);
    let html = `
        <div>Toplam bakƒ±lan kelime: <b>${kelimeSay}</b></div>
        <div>En √ßok bakƒ±lan kelimeler:</div>
        <ul>
        ${enCok.map(([k, v])=>`<li>${k} (${v} kez)</li>`).join("")}
        </ul>
        <div>Son okuma: ${stats.okumaZamani ? new Date(stats.okumaZamani).toLocaleString():"-"}</div>
    `;
    document.getElementById("stats-content").innerHTML = html;
    document.getElementById("stats-modal").style.display = "flex";
};
window.closeStatsModal = function() { document.getElementById("stats-modal").style.display="none"; };

// Se√ßili metni √ßevir
window.showTranslateModal = function() {
    let txt = window.getSelection().toString();
    if (!txt) txt = prompt("√áevirmek istediƒüin metni gir:");
    if (!txt) return;
    let url = "https://translate.google.com/?sl=de&tl=tr&text=" + encodeURIComponent(txt) + "&op=translate";
    document.getElementById("translate-area").innerHTML = `
        <div style="font-size:1.08em;margin-bottom:12px;">√áevrilecek metin:<br><b>${txt}</b></div>
        <a href="${url}" target="_blank" style="color:#226be6;font-weight:600;font-size:1.09em;text-decoration:none;">Google Translate'de A√ß</a>
    `;
    document.getElementById("translate-modal").style.display = "flex";
};
window.closeTranslateModal = function() { document.getElementById("translate-modal").style.display="none"; };

// Not modalƒ±
window.closeNoteModal = function() { document.getElementById("note-modal").style.display="none"; };

// Modal kapatƒ±cƒ±lar
window.onclick = function(event) {
    ["favorites-modal","sources-modal","stats-modal","note-modal","translate-modal"].forEach(id=>{
        let m = document.getElementById(id);
        if (event.target === m) m.style.display="none";
    });
};

// Gece, odak, satƒ±r ilerleme gibi okuma modlarƒ± i√ßin tema fonksiyonunu √∂zelle≈ütirebilirsin
// ... (isteƒüine g√∂re ek fonksiyonlar eklenebilir)
</script>


// Utility Bar Butonlarƒ± (Favori, ƒ∞statistik, Alƒ±ntƒ±)
document.getElementById("fav-btn").onclick = showFavoritesModal;
document.getElementById("stats-btn").onclick = showStatsModal;
document.getElementById("quotes-btn").onclick = function() {
  document.getElementById("quotes-modal").style.display = 'flex';
};
